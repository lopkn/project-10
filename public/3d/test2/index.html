<!DOCTYPE html>
<html>
  <meta charset="UTF-8" />
  <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

  <style>
    html,
      body {
        margin: 0;
        padding: 0;
      }

    #debug {
      position: absolute;
      top:0;
      left:0;
      color: #ff9999;
    }

  </style>
  <body>


    <script id="vertexShader" type="x-shader/x-vertex">
      void main(){

        gl_Position = vec4(1.0, 1.0, 1.0, 1.0);

      }

  </script>

  <script id="fragmentShader" type="x-shader/x-fragment">


    void main() {


      gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);

    }

  </script>





    <script type="importmap">
        {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three/examples/jsm/",
          "@three.ez/instanced-mesh": "https://cdn.jsdelivr.net/npm/@three.ez/instanced-mesh/build/index.js",
          "bvh.js": "https://cdn.jsdelivr.net/npm/bvh.js/build/index.js"
        }
    }
    </script>


    <script type="module">

        import * as THREE from 'three';

        import { InstancedMesh2 } from '@three.ez/instanced-mesh';
        import { createRadixSort } from '@three.ez/instanced-mesh';

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
          50,
          window.innerWidth / window.innerHeight,
          0.01,
          999999
        );


        // RENDERER
        const renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
        renderer.shadowMap.enabled = true;
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x103030);
        window.addEventListener("resize", onWindowResize);
        document.body.appendChild(renderer.domElement);





      function starcloud(count=5000,mov=()=>{},geometry = new THREE.BoxGeometry(1, 1, 1)){

            var materials = new THREE.RawShaderMaterial( {

              uniforms: {
                'test1': { value: 1.0 }
              },
              vertexShader: document.getElementById( 'vertexShader' ).textContent,
              fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
              side: THREE.DoubleSide,
              // forceSinglePass: true,

          } )


          let mesh = new InstancedMesh2( geometry, materials, count );
          mesh.instanceMatrix.setUsage( THREE.DynamicDrawUsage ); // will be updated every frame
          mesh.initUniformsPerInstance({ fragment: { metalness: 'float'}});
          mesh.addInstances(count);

          let dummy = new THREE.Object3D()
          for ( let i = 0; i < count; i ++) {
              mov(dummy,i)
              dummy.updateMatrix();
              mesh.setUniformAt(i, 'metalness', 1.0);
              mesh.setMatrixAt( i, dummy.matrix );
          }

          scene.add(mesh);
          console.log("hey")
          return(mesh)
      }
      
 



      function init() {
        scene.add(new THREE.AmbientLight(0x888888, 1));
        starcloud()
      }


      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate() {

        requestAnimationFrame(animate);
        renderer.render(scene, camera);

      }

      document.addEventListener("wheel",(e)=>{
          camera.translateZ(e.deltaY)
      })





      init();
      animate();
    </script>
  </body>
</html>











