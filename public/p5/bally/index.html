<!DOCTYPE html>
<html>
<head>
<link rel="icon" href="../../images/psim2.png">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable = no, maximum-scale=1, minimum-scale=1">
  <title>LTPT</title>

</head>
<body style="padding:0;margin:0;background-color: black;">
  
<!--     <script src="/socket.io/socket.io.js"></script>
 <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script> -->

  <div draggable="false" ondragstart="return false">

	  <script src="../p5.js"></script>

<!--TONE JS STUFF-->

<!-- 

    <button id = "wow" top="0px" left = "0px" style = "z-index:20; color: rgba(0,150,255,0.2);background-color: transparent;font-size: 50px;width:100%;height:100%;border-radius: 1px;position:absolute" onclick = "
      // window.navigator.vibrate(200)
      const player = new Tone.Player('./start.wav').toDestination();
    Tone.loaded().then(() => {
      player.start();
      player.stop()
    });
      

      console.log('tone start');

      soundInit()
      document.getElementById('wow').remove()
    ">click to start..</button>
    <script src="tone.js"></script> 

-->
<!--TONE JS STUFF-->


<script>

  var Width = window.innerWidth
  var Height = window.innerHeight
  var scrMax = Math.max(Width,Height)
  var w2 = Width/2
  var h2 = Height/2

  let globalRands = []
  for(let i = 0; i < 100; i++){
    globalRands.push(Math.random())
  }

function setup() {
  createCanvas(window.innerWidth, window.innerHeight);
  frameRate(60)
  colorMode(HSL,100,100,100,255)
  rgaus = randomGaussian
  particles.push(new bally())
}

var hfunc = Math.random()>0.5?(()=>{return(Date.now()/100%100)}):(()=>{return(Date.now()%100)})

function intersects(a,b,c,d,p,q,r,s) {
  var det, gamma, lambda;
  det = (c - a) * (s - q) - (r - p) * (d - b);
  if (det === 0) {
    return false;
  } else {
    lambda = ((s - q) * (r - a) + (p - r) * (s - b)) / det;
    gamma = ((b - d) * (r - a) + (c - a) * (s - b)) / det;
    if ( (0 < lambda && lambda < 1) && (0 < gamma && gamma < 1) ) {
      return([a+lambda*(c-a),b+lambda*(d-b)])
    };
    return(false)
  }
};

class liney{
  constructor(x=Width/2,y=Height/2){
    this.x = x
    this.y = y
    this.vx = 0
    this.vy = 0
    this.points = [[x,y],[x,y],[x,y],[x,y],[x,y],[x,y]]
  }
  update(dt=1){
    this.x += this.vx*dt
    this.y += this.vy*dt

    this.points.push([this.x,this.y])

    if(!this.noRand){
    this.vx += (Math.random()-0.5)*scrMax/1500
    this.vy += (Math.random()-0.5)*scrMax/1500
    this.vx *= 0.999
    this.vy *= 0.999
    }

    let d = dist(this.x,this.y,w2,h2)

    this.vx -= (this.x-w2)/(d+1)*0.5
    this.vy -= (this.y-h2)/(d+1)*0.5

    if(this.points.length>150){
      this.points.splice(0,1)
    }

    let p = this.points[this.points.length-1] //this point
    let lp = this.points[this.points.length-2] //last point

    for(let i = 0; i < this.points.length-2; i++){
      let tp = this.points[i]
      let tp2 = this.points[i+1]
      let int = intersects(tp[0],tp[1],tp2[0],tp2[1],p[0],p[1],lp[0],lp[1])
      if(int){
        let arr = [[int[0],int[1]]]
        for(let j = i; j < this.points.length-1; j++){
          arr.push([this.points[j][0],this.points[j][1]])
        }
        particles.push({"arr":arr,"life":100,
          "h":hfunc(),
          "update":(x)=>{x.life-=1;if(x.life<=0){return("delete")}},
          "draw":(x)=>{
            noStroke()
            fill(x.h,100,50,x.life)
            beginShape()
            for(let i = 0; i < arr.length;i++){
              vertex(...arr[i])
            }
            endShape(CLOSE);
          }})
        break;
      }
    }

  }

  draw(){
    stroke(0)
    for(let i = 0; i < this.points.length-1;i++){
      let p1 = this.points[i]
      let p2 = this.points[i+1]
      line(p1[0],p1[1],p2[0],p2[1])
    }
  }
}

var rand = (x)=>{
  if(x == undefined){return(Math.random())}
  if(x < 1){return(Math.random()<x)}
  return(Math.random()*x)
}

class bally{
  constructor(dvx=rgaus(0,3),dvy=rgaus(0,3),size= rgaus(10,1)){
    this.x = rand()*Width*2-Width*0.5
    this.y = rand()*Height*2-Height*0.5

    this.vx = dvx
    this.vy = dvy

    if(globalRands[0]>0.7){
        this.grav = [w2,h2]
    } else if(globalRands[0]>0.4){
        this.grav = [rand(Width),rand(Height)]
    } else if(rand(0.01)){
        this.grav = [rand(Width),rand(Height)]
    }

    this.ax = 0
    this.ay = 0

    if(rand(0.05)){
      this.vx *= 0.4
      this.vy *= 0.4
      this.ax = rgaus(0,0.07)
      this.ay = rgaus(0,0.07)
    }


    this.size = Math.abs(size)

    this.life = 0
    this.spawn = Date.now()
    this.h = Math.random()*100
    this.depletion = rand(2)

    if(globalRands[1]>0.006){
      this.flier = rand(0.3)
      if(this.flier){
        this.size *= Math.abs(rgaus(0,1))
      }
      this.spin = rand(globalRands[2])?1:-1
    }

    if(!this.flier){
      if(rand(0.1)){
        this.size *= Math.abs(rgaus(0,5))
      } 
    }

  }
  update(){
    let dt = 1
    this.vx += this.ax
    this.vy += this.ay
    this.x += this.vx*dt
    this.y += this.vy*dt
    this.life+=1+this.depletion
    if(this.life > 255*2){
      return("delete")
    }

    if(this.grav){
      let g = this.grav
      let d = dist(this.x,this.y,g[0],g[1])

      this.vx -= (this.x-g[0])*50/(d*d+1)
      this.vy -= (this.y-g[1])*50/(d*d+1)
    }

  }

  draw(){
    if(this.life<255){
      fill(this.h,100,50,this.life)
    } else {
      fill(this.h,100,50,255*2-this.life)
    }


    if(this.flier){
      strokeWeight(this.size/3)
      if(this.life<255){
        stroke(this.h,100,50,this.life)
      } else {
        stroke(this.h,100,50,255*2-this.life)
      }

      let dx = Math.cos((Date.now()/100*this.spin)%(Math.PI*2))*this.size
      let dy = Math.sin((Date.now()/100*this.spin)%(Math.PI*2))*this.size
      line(this.x+dx,this.y+dy,this.x-dx,this.y-dy)
    }else{
    noStroke()
      circle(this.x,this.y,this.size)
    }
  }
}


var particles = []

let la = []

var rgaus = ()=>{return(1)}

// while(Math.random()>0.75){
//   la.push(new liney())
// }

function draw() {
  background(120,0,0);

  if(Math.random()>0.7){
    particles.push(new bally())
  }

  for(let i = particles.length-1; i>-1; i--){
    if(particles[i].update(particles[i])=="delete"){
      particles.splice(i,1)
      continue;
    }
    particles[i].draw(particles[i])
  }
  
}
</script>

<!--script src="sketch.js"></script-->
</body>
</html>
